<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Deploying a Multi-Stage RecSys into Production with Merlin Systems and Triton Inference Server &mdash; Merlin  documentation</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "tex2jax_ignore|mathjax_ignore|document", "processClass": "tex2jax_process|mathjax_process|math|output_area"}})</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> Merlin
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../README.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Example Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../containers.html">Merlin Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../support_matrix/index.html">Support Matrix</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Merlin</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Deploying a Multi-Stage RecSys into Production with Merlin Systems and Triton Inference Server</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Copyright 2021 NVIDIA Corporation. All Rights Reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1"># ================================</span>
</pre></div>
</div>
</div>
<p><img alt="74ba0380d28b4d4eaa220ddefdd88e7b" src="http://developer.download.nvidia.com/compute/machine-learning/frameworks/nvidia_logo.png" /></p>
<div class="section" id="Deploying-a-Multi-Stage-RecSys-into-Production-with-Merlin-Systems-and-Triton-Inference-Server">
<h1>Deploying a Multi-Stage RecSys into Production with Merlin Systems and Triton Inference Server<a class="headerlink" href="#Deploying-a-Multi-Stage-RecSys-into-Production-with-Merlin-Systems-and-Triton-Inference-Server" title="Permalink to this headline"></a></h1>
<p>At this point, when you reach out to this notebook, we expect that you have already executed the first notebook <code class="docutils literal notranslate"><span class="pre">01-Building-Recommender-Systems-with-Merlin.ipynb</span></code> and exported all the required files and models.</p>
<p>We are going to generate recommended items for a given user query (user_id) by following the steps described in the figure below.</p>
<p><img alt="tritonensemble" src="../../_images/triton_ensemble.png" /></p>
<p>Merlin Systems library have the set of operators to be able to serve multi-stage recommender systems built with Tensorflow on <a class="reference external" href="https://github.com/triton-inference-server/server">Triton Inference Server</a>(TIS) easily and efficiently. Below, we will go through these operators and demonstrate their usage in serving a multi-stage system on Triton.</p>
<div class="section" id="Import-required-libraries-and-functions">
<h2>Import required libraries and functions<a class="headerlink" href="#Import-required-libraries-and-functions" title="Permalink to this headline"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">feast</span>
<span class="kn">import</span> <span class="nn">faiss</span>
<span class="kn">from</span> <span class="nn">nvtabular</span> <span class="kn">import</span> <span class="n">ColumnSchema</span><span class="p">,</span> <span class="n">Schema</span>

<span class="kn">from</span> <span class="nn">merlin.systems.dag.ensemble</span> <span class="kn">import</span> <span class="n">Ensemble</span>
<span class="kn">from</span> <span class="nn">merlin.systems.dag.ops.session_filter</span> <span class="kn">import</span> <span class="n">FilterCandidates</span>
<span class="kn">from</span> <span class="nn">merlin.systems.dag.ops.softmax_sampling</span> <span class="kn">import</span> <span class="n">SoftmaxSampling</span>
<span class="kn">from</span> <span class="nn">merlin.systems.dag.ops.tensorflow</span> <span class="kn">import</span> <span class="n">PredictTensorflow</span>
<span class="kn">from</span> <span class="nn">merlin.systems.dag.ops.unroll_features</span> <span class="kn">import</span> <span class="n">UnrollFeatures</span>
<span class="kn">from</span> <span class="nn">merlin.systems.triton.utils</span> <span class="kn">import</span> <span class="n">run_triton_server</span><span class="p">,</span> <span class="n">run_ensemble_on_tritonserver</span>
</pre></div>
</div>
</div>
<p>We use <code class="docutils literal notranslate"><span class="pre">configure_tensorflow</span></code> function to prevent the Tensorflow to claim entire GPU memory. With this func, we let TF to allocate 50% of the available GPU memory.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nvtabular.loader.tf_utils</span> <span class="kn">import</span> <span class="n">configure_tensorflow</span>
<span class="n">configure_tensorflow</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
04/05/2022 06:52:55 PM INFO:init
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;function tensorflow.python.dlpack.dlpack.from_dlpack(dlcapsule)&gt;
</pre></div></div>
</div>
</div>
<div class="section" id="Register-our-features-on-feature-store">
<h2>Register our features on feature store<a class="headerlink" href="#Register-our-features-on-feature-store" title="Permalink to this headline"></a></h2>
<p>The Feast feature registry is a central catalog of all the feature definitions and their related metadata(read more <a class="reference external" href="https://docs.feast.dev/getting-started/architecture-and-components/registry">here</a>). We have defined our user and item features definitions in the <code class="docutils literal notranslate"><span class="pre">user_features.py</span></code> and <code class="docutils literal notranslate"><span class="pre">item_features.py</span></code> files. With FeatureView() users can register data sources in their organizations into Feast, and then use those data sources for both training and online inference. In the
<code class="docutils literal notranslate"><span class="pre">user_features.py</span></code> and <code class="docutils literal notranslate"><span class="pre">item_features.py</span></code> files, we are telling Feast where to find user and item features.</p>
<p>Before we move on to the next steps, we need to perform <code class="docutils literal notranslate"><span class="pre">feast</span> <span class="pre">apply</span></code>command as directed below. With that, we register our features, we can apply the changes to create our feature registry and store all entity and feature view definitions in a local SQLite online store called <code class="docutils literal notranslate"><span class="pre">online_store.db</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">BASE_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;BASE_DIR&quot;</span><span class="p">,</span> <span class="s2">&quot;/Merlin/examples/Deploying-multi-stage-RecSys/&quot;</span><span class="p">)</span>

<span class="c1"># define feature repo path</span>
<span class="n">feast_repo_path</span> <span class="o">=</span> <span class="n">BASE_DIR</span> <span class="o">+</span> <span class="s2">&quot;feature_repo/&quot;</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">cd</span> $feast_repo_path
<span class="o">!</span>feast apply
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
/Merlin/examples/Deploying-multi-stage-RecSys/feature_repo
/usr/local/lib/python3.8/dist-packages/feast/feature_view.py:100: DeprecationWarning: The argument &#39;input&#39; is being deprecated. Please use &#39;batch_source&#39; instead. Feast 0.13 and onwards will not support the argument &#39;input&#39;.
  warnings.warn(
Created data source <span class="ansi-green-intense-fg ansi-bold">/Merlin/examples/Deploying-multi-stage-RecSys/feature_repo/data/user_features.parquet</span>
Created data source <span class="ansi-green-intense-fg ansi-bold">/Merlin/examples/Deploying-multi-stage-RecSys/feature_repo/data/item_features.parquet</span>
Created entity <span class="ansi-green-intense-fg ansi-bold">item_id</span>
Created entity <span class="ansi-green-intense-fg ansi-bold">user_id</span>
Created feature view <span class="ansi-green-intense-fg ansi-bold">item_features</span>
Created feature view <span class="ansi-green-intense-fg ansi-bold">user_features</span>

Created sqlite table <span class="ansi-green-intense-fg ansi-bold">feature_repo_item_features</span>
Created sqlite table <span class="ansi-green-intense-fg ansi-bold">feature_repo_user_features</span>

</pre></div></div>
</div>
</div>
<div class="section" id="Loading-features-from-offline-store-into-an-online-store">
<h2>Loading features from offline store into an online store<a class="headerlink" href="#Loading-features-from-offline-store-into-an-online-store" title="Permalink to this headline"></a></h2>
<p>After we execute <code class="docutils literal notranslate"><span class="pre">apply</span></code> and registered our features and created our online local store, now we need to perform <a class="reference external" href="https://docs.feast.dev/how-to-guides/running-feast-in-production">materialization</a> operation. This is done to keep our online store up to date and get it ready for prediction. For that we need to run a job that loads feature data from our feature view sources into our online store. As we add new features to our offline stores, we can continuously materialize them to keep our
online store up to date by finding the latest feature values for each user.</p>
<p>When you run the <code class="docutils literal notranslate"><span class="pre">feast</span> <span class="pre">materialize</span> <span class="pre">..</span></code> command below, you will see a message Materializing 2 feature views from 1995-01-01 01:01:01+00:00 to 2025-01-01 01:01:01+00:00 into the sqlite online store will be printed out.</p>
<p>Note that materialization step takes some time..</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>feast materialize <span class="m">1995</span>-01-01T01:01:01 <span class="m">2025</span>-01-01T01:01:01
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Materializing <span class="ansi-green-intense-fg ansi-bold">2</span> feature views from <span class="ansi-green-intense-fg ansi-bold">1995-01-01 01:01:01+00:00</span> to <span class="ansi-green-intense-fg ansi-bold">2025-01-01 01:01:01+00:00</span> into the <span class="ansi-green-intense-fg ansi-bold">sqlite</span> online store.

<span class="ansi-green-intense-fg ansi-bold">item_features</span>:
100%|█████████████████████████████████████████████████████████| 1298/1298 [00:00&lt;00:00, 5214.52it/s]
<span class="ansi-green-intense-fg ansi-bold">user_features</span>:
100%|█████████████████████████████████████████████████████████| 1322/1322 [00:00&lt;00:00, 1621.24it/s]
</pre></div></div>
</div>
<p>Now, let’s check our feature_repo structure again after we ran <code class="docutils literal notranslate"><span class="pre">apply</span></code> and <code class="docutils literal notranslate"><span class="pre">materialize</span></code> commands.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set up the base dir to for feature store</span>
<span class="n">feature_repo_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s1">&#39;feature_repo&#39;</span><span class="p">)</span>
<span class="o">!</span>tree <span class="nv">$feature_repo_path</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-blue-intense-fg ansi-bold">/Merlin/examples/Deploying-multi-stage-RecSys/feature_repo</span>
├── __init__.py
├── <span class="ansi-blue-intense-fg ansi-bold">data</span>
│   ├── item_features.parquet
│   ├── online_store.db
│   ├── registry.db
│   └── user_features.parquet
├── feature_store.yaml
├── item_features.py
└── user_features.py

1 directory, 8 files
</pre></div></div>
</div>
</div>
<div class="section" id="Set-up-Faiss-index,-create-feature-store-client-and-objects-for-the-Triton-ensemble">
<h2>Set up Faiss index, create feature store client and objects for the Triton ensemble<a class="headerlink" href="#Set-up-Faiss-index,-create-feature-store-client-and-objects-for-the-Triton-ensemble" title="Permalink to this headline"></a></h2>
<p>Create a folder for faiss index path</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span> <span class="o">+</span> <span class="s1">&#39;faiss_index&#39;</span><span class="p">)):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span> <span class="o">+</span> <span class="s1">&#39;faiss_index&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>Define paths for ranking model, retrieval model, and faiss index path</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">faiss_index_path</span> <span class="o">=</span> <span class="n">BASE_DIR</span> <span class="o">+</span> <span class="s1">&#39;faiss_index&#39;</span> <span class="o">+</span> <span class="s2">&quot;/index.faiss&quot;</span>
<span class="n">retrieval_model_path</span> <span class="o">=</span> <span class="n">BASE_DIR</span> <span class="o">+</span> <span class="s2">&quot;query_tower/&quot;</span>
<span class="n">ranking_model_path</span> <span class="o">=</span> <span class="n">BASE_DIR</span> <span class="o">+</span> <span class="s2">&quot;dlrm/&quot;</span>
</pre></div>
</div>
</div>
<p>Create a request schema that we are going to use when sending a request to Triton Infrence Server (TIS).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">request_schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">ColumnSchema</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">QueryFaiss</span></code> operator creates an interface between a FAISS Approximate Nearest Neighbors (ANN) Index and Triton Infrence Server. For a given input query vector, we do an ANN search query to find the ids of top-k nearby nodes in the index.</p>
<p><code class="docutils literal notranslate"><span class="pre">setup_faiss</span></code> is a utility function that will create a Faiss index from an embedding vector with using L2 distance.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">merlin.systems.dag.ops.faiss</span> <span class="kn">import</span> <span class="n">QueryFaiss</span><span class="p">,</span> <span class="n">setup_faiss</span>

<span class="n">item_embeddings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">BASE_DIR</span> <span class="o">+</span> <span class="s2">&quot;item_embeddings.parquet&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">setup_faiss</span><span class="p">(</span><span class="n">item_embeddings</span><span class="p">,</span> <span class="n">faiss_index_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Create feature store client.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">feature_store</span> <span class="o">=</span> <span class="n">feast</span><span class="o">.</span><span class="n">FeatureStore</span><span class="p">(</span><span class="n">feast_repo_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Fetch user features with <code class="docutils literal notranslate"><span class="pre">QueryFeast</span></code> operator from the feature store. <code class="docutils literal notranslate"><span class="pre">QueryFeast</span></code> operator is responsible for ensuring that our feast feature store can communicate correctly with tritonserver for the ensemble feast feature look ups.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">merlin.systems.dag.ops.feast</span> <span class="kn">import</span> <span class="n">QueryFeast</span>

<span class="n">user_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">QueryFeast</span><span class="o">.</span><span class="n">from_feature_view</span><span class="p">(</span>
    <span class="n">store</span><span class="o">=</span><span class="n">feature_store</span><span class="p">,</span>
    <span class="n">view</span><span class="o">=</span><span class="s2">&quot;user_features&quot;</span><span class="p">,</span>
    <span class="n">column</span><span class="o">=</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span>
    <span class="n">include_id</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/systems/merlin/systems/dag/ops/feast.py:15: DeprecationWarning: `np.float` is a deprecated alias for the builtin `float`. To silence this warning, use `float` by itself. Doing this will not modify any behavior and is safe. If you specifically wanted the numpy scalar type, use `np.float64` here.
Deprecated in NumPy 1.20; for more details and guidance: https://numpy.org/devdocs/release/1.20.0-notes.html#deprecations
  ValueType.FLOAT: (np.float, False, False),
</pre></div></div>
</div>
<p>Retrieve top-K candidate items using <code class="docutils literal notranslate"><span class="pre">retrieval</span> <span class="pre">model</span></code> that are relevant for a given user. We use <code class="docutils literal notranslate"><span class="pre">PredictTensorflow()</span></code> operator that takes a tensorflow model and packages it correctly for TIS to run with the tensorflow backend.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retrieval</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">user_features</span>
    <span class="o">&gt;&gt;</span> <span class="n">PredictTensorflow</span><span class="p">(</span><span class="n">retrieval_model_path</span><span class="p">)</span>
    <span class="o">&gt;&gt;</span> <span class="n">QueryFaiss</span><span class="p">(</span><span class="n">faiss_index_path</span><span class="p">,</span> <span class="n">topk</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
2022-04-05 18:53:03.680149: I tensorflow/core/platform/cpu_feature_guard.cc:151] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 AVX512F FMA
To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.
2022-04-05 18:53:04.788233: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1525] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 16254 MB memory:  -&gt; device: 0, name: Quadro GV100, pci bus id: 0000:15:00.0, compute capability: 7.0
04/05/2022 06:53:06 PM WARNING:No training configuration found in save file, so the model was *not* compiled. Compile it manually.
</pre></div></div>
</div>
<p>Fetch item features for the candidate items that are retrieved from the retrieval step above from the feature store.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">item_features</span> <span class="o">=</span> <span class="n">retrieval</span><span class="p">[</span><span class="s2">&quot;candidate_ids&quot;</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">QueryFeast</span><span class="o">.</span><span class="n">from_feature_view</span><span class="p">(</span>
    <span class="n">store</span><span class="o">=</span><span class="n">feature_store</span><span class="p">,</span>
    <span class="n">view</span><span class="o">=</span><span class="s2">&quot;item_features&quot;</span><span class="p">,</span>
    <span class="n">column</span><span class="o">=</span><span class="s2">&quot;candidate_ids&quot;</span><span class="p">,</span>
    <span class="n">output_prefix</span><span class="o">=</span><span class="s2">&quot;item&quot;</span><span class="p">,</span>
    <span class="n">include_id</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>Merge the user features and items features to create the all set of combined features that were used in model training using <code class="docutils literal notranslate"><span class="pre">UnrollFeatures</span></code> operator which takes a target column and joins the “unroll” columns to the target. This helps when broadcasting a series of user features to a set of items.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">user_features_to_unroll</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;user_id&quot;</span><span class="p">,</span>
    <span class="s2">&quot;user_shops&quot;</span><span class="p">,</span>
    <span class="s2">&quot;user_profile&quot;</span><span class="p">,</span>
    <span class="s2">&quot;user_group&quot;</span><span class="p">,</span>
    <span class="s2">&quot;user_gender&quot;</span><span class="p">,</span>
    <span class="s2">&quot;user_age&quot;</span><span class="p">,</span>
    <span class="s2">&quot;user_consumption_2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;user_is_occupied&quot;</span><span class="p">,</span>
    <span class="s2">&quot;user_geography&quot;</span><span class="p">,</span>
    <span class="s2">&quot;user_intentions&quot;</span><span class="p">,</span>
    <span class="s2">&quot;user_brands&quot;</span><span class="p">,</span>
    <span class="s2">&quot;user_categories&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">combined_features</span> <span class="o">=</span> <span class="n">item_features</span> <span class="o">&gt;&gt;</span> <span class="n">UnrollFeatures</span><span class="p">(</span>
    <span class="s2">&quot;item_id&quot;</span><span class="p">,</span> <span class="n">user_features</span><span class="p">[</span><span class="n">user_features_to_unroll</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>Rank the combined features using the trained ranking model, which is a DLRM model for this example. We feed the path of the ranking model to <code class="docutils literal notranslate"><span class="pre">PredictTensorflow()</span></code> operator.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ranking</span> <span class="o">=</span> <span class="n">combined_features</span> <span class="o">&gt;&gt;</span> <span class="n">PredictTensorflow</span><span class="p">(</span><span class="n">ranking_model_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>For the ordering we use <code class="docutils literal notranslate"><span class="pre">SoftmaxSampling()</span></code> operator. This operator sorts all inputs in descending order given the input ids and prediction introducing some randomization into the ordering by sampling items from the softmax of the predicted relevance scores, and finally returns top-k ordered items.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ordering</span> <span class="o">=</span> <span class="n">combined_features</span><span class="p">[</span><span class="s2">&quot;item_id&quot;</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">SoftmaxSampling</span><span class="p">(</span>
    <span class="n">relevance_col</span><span class="o">=</span><span class="n">ranking</span><span class="p">[</span><span class="s2">&quot;output_1&quot;</span><span class="p">],</span> <span class="n">topk</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">20.0</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Export-Graph-as-Ensemble">
<h2>Export Graph as Ensemble<a class="headerlink" href="#Export-Graph-as-Ensemble" title="Permalink to this headline"></a></h2>
<p>The last step is to create the ensemble artifacts that TIS can consume. To make these artifacts import the Ensemble class. This class represents an entire ensemble consisting of multiple models that run sequentially in TIS initiated by an inference request. It is responsible with interpreting the graph and exporting the correct files for TIS.</p>
<p>When we create an Ensemble object we feed the graph and a schema representing the starting input of the graph. After we create the ensemble object, we export the graph, supplying an export path for the <code class="docutils literal notranslate"><span class="pre">ensemble.export()</span></code> function. This returns an ensemble config which represents the entire inference pipeline and a list of node-specific configs.</p>
<p>Create the folder to export the models and config files.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span> <span class="o">+</span> <span class="s1">&#39;poc_ensemble&#39;</span><span class="p">)):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span> <span class="o">+</span> <span class="s1">&#39;poc_ensemble&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># define the path where all the models and config files exported to</span>
<span class="n">export_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span> <span class="o">+</span> <span class="s1">&#39;poc_ensemble&#39;</span><span class="p">)</span>

<span class="n">ensemble</span> <span class="o">=</span> <span class="n">Ensemble</span><span class="p">(</span><span class="n">ordering</span><span class="p">,</span> <span class="n">request_schema</span><span class="p">)</span>
<span class="n">ens_config</span><span class="p">,</span> <span class="n">node_configs</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">export_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Let’s check our export_path structure</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>tree <span class="nv">$export_path</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-blue-intense-fg ansi-bold">/Merlin/examples/Deploying-multi-stage-RecSys/poc_ensemble</span>
├── <span class="ansi-blue-intense-fg ansi-bold">0_queryfeast</span>
│   ├── <span class="ansi-blue-intense-fg ansi-bold">1</span>
│   │   └── model.py
│   └── config.pbtxt
├── <span class="ansi-blue-intense-fg ansi-bold">1_predicttensorflow</span>
│   ├── <span class="ansi-blue-intense-fg ansi-bold">1</span>
│   │   └── <span class="ansi-blue-intense-fg ansi-bold">model.savedmodel</span>
│   │       ├── <span class="ansi-blue-intense-fg ansi-bold">assets</span>
│   │       ├── keras_metadata.pb
│   │       ├── saved_model.pb
│   │       └── <span class="ansi-blue-intense-fg ansi-bold">variables</span>
│   │           ├── variables.data-00000-of-00001
│   │           └── variables.index
│   └── config.pbtxt
├── <span class="ansi-blue-intense-fg ansi-bold">2_queryfaiss</span>
│   ├── <span class="ansi-blue-intense-fg ansi-bold">1</span>
│   │   ├── <span class="ansi-blue-intense-fg ansi-bold">index.faiss</span>
│   │   │   └── index.faiss
│   │   └── model.py
│   └── config.pbtxt
├── <span class="ansi-blue-intense-fg ansi-bold">3_queryfeast</span>
│   ├── <span class="ansi-blue-intense-fg ansi-bold">1</span>
│   │   └── model.py
│   └── config.pbtxt
├── <span class="ansi-blue-intense-fg ansi-bold">4_unrollfeatures</span>
│   ├── <span class="ansi-blue-intense-fg ansi-bold">1</span>
│   │   └── model.py
│   └── config.pbtxt
├── <span class="ansi-blue-intense-fg ansi-bold">5_predicttensorflow</span>
│   ├── <span class="ansi-blue-intense-fg ansi-bold">1</span>
│   │   └── <span class="ansi-blue-intense-fg ansi-bold">model.savedmodel</span>
│   │       ├── <span class="ansi-blue-intense-fg ansi-bold">assets</span>
│   │       ├── keras_metadata.pb
│   │       ├── saved_model.pb
│   │       └── <span class="ansi-blue-intense-fg ansi-bold">variables</span>
│   │           ├── variables.data-00000-of-00001
│   │           └── variables.index
│   └── config.pbtxt
├── <span class="ansi-blue-intense-fg ansi-bold">6_softmaxsampling</span>
│   ├── <span class="ansi-blue-intense-fg ansi-bold">1</span>
│   │   └── model.py
│   └── config.pbtxt
└── <span class="ansi-blue-intense-fg ansi-bold">ensemble_model</span>
    ├── <span class="ansi-blue-intense-fg ansi-bold">1</span>
    └── config.pbtxt

23 directories, 22 files
</pre></div></div>
</div>
</div>
<div class="section" id="Retrieving-Recommendations-from-Triton">
<h2>Retrieving Recommendations from Triton<a class="headerlink" href="#Retrieving-Recommendations-from-Triton" title="Permalink to this headline"></a></h2>
<p>It is time to deploy the all the models as an ensemble model to Triton Inference very easily using Merlin Systems library. Now we can launch our triton server and load our models, and get a response for our query with a utility function <code class="docutils literal notranslate"><span class="pre">run_ensemble_on_tritonserver()</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create a request to be sent to TIS</span>
<span class="kn">from</span> <span class="nn">merlin.core.dispatch</span> <span class="kn">import</span> <span class="n">make_df</span>

<span class="n">request</span> <span class="o">=</span> <span class="n">make_df</span><span class="p">({</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]})</span>
<span class="n">request</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">run_ensemble_on_tritonserver</span><span class="p">(</span>
    <span class="n">export_path</span><span class="p">,</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">output_schema</span><span class="o">.</span><span class="n">column_names</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="s2">&quot;ensemble_model&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
I0405 18:53:12.285197 12809 tensorflow.cc:2176] TRITONBACKEND_Initialize: tensorflow
I0405 18:53:12.285284 12809 tensorflow.cc:2186] Triton TRITONBACKEND API version: 1.8
I0405 18:53:12.285289 12809 tensorflow.cc:2192] &#39;tensorflow&#39; TRITONBACKEND API version: 1.8
I0405 18:53:12.285293 12809 tensorflow.cc:2216] backend configuration:
{&#34;cmdline&#34;:{&#34;version&#34;:&#34;2&#34;}}
I0405 18:53:12.434720 12809 pinned_memory_manager.cc:240] Pinned memory pool is created at &#39;0x7fd4f8000000&#39; with size 268435456
I0405 18:53:12.435114 12809 cuda_memory_manager.cc:105] CUDA memory pool is created on device 0 with size 67108864
I0405 18:53:12.440615 12809 model_repository_manager.cc:994] loading: 0_queryfeast:1
I0405 18:53:12.541023 12809 model_repository_manager.cc:994] loading: 1_predicttensorflow:1
I0405 18:53:12.544542 12809 backend.cc:46] TRITONBACKEND_Initialize: nvtabular
I0405 18:53:12.544572 12809 backend.cc:53] Triton TRITONBACKEND API version: 1.8
I0405 18:53:12.544585 12809 backend.cc:56] &#39;nvtabular&#39; TRITONBACKEND API version: 1.8
I0405 18:53:12.544858 12809 backend.cc:76] Loaded libpython successfully
I0405 18:53:12.641295 12809 model_repository_manager.cc:994] loading: 2_queryfaiss:1
I0405 18:53:12.712613 12809 backend.cc:89] Python interpreter is initialized
I0405 18:53:12.713774 12809 tensorflow.cc:2276] TRITONBACKEND_ModelInitialize: 1_predicttensorflow (version 1)
I0405 18:53:12.715248 12809 model_inst_state.hpp:64] Loading TritonPythonnModel from model.py in path &#39;/Merlin/examples/Deploying-multi-stage-RecSys/poc_ensemble/0_queryfeast/1&#39;
I0405 18:53:12.743586 12809 model_repository_manager.cc:994] loading: 3_queryfeast:1
I0405 18:53:12.844174 12809 model_repository_manager.cc:994] loading: 4_unrollfeatures:1
I0405 18:53:12.944631 12809 model_repository_manager.cc:994] loading: 5_predicttensorflow:1
I0405 18:53:13.044995 12809 model_repository_manager.cc:994] loading: 6_softmaxsampling:1
I0405 18:53:14.728975 12809 tensorflow.cc:2325] TRITONBACKEND_ModelInstanceInitialize: 1_predicttensorflow (GPU device 0)
I0405 18:53:14.729115 12809 model_repository_manager.cc:1149] successfully loaded &#39;0_queryfeast&#39; version 1
2022-04-05 18:53:15.913993: I tensorflow/cc/saved_model/reader.cc:43] Reading SavedModel from: /Merlin/examples/Deploying-multi-stage-RecSys/poc_ensemble/1_predicttensorflow/1/model.savedmodel
2022-04-05 18:53:15.919091: I tensorflow/cc/saved_model/reader.cc:107] Reading meta graph with tags { serve }
2022-04-05 18:53:15.919132: I tensorflow/cc/saved_model/reader.cc:148] Reading SavedModel debug info (if present) from: /Merlin/examples/Deploying-multi-stage-RecSys/poc_ensemble/1_predicttensorflow/1/model.savedmodel
2022-04-05 18:53:15.925459: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1525] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 13584 MB memory:  -&gt; device: 0, name: Quadro GV100, pci bus id: 0000:15:00.0, compute capability: 7.0
2022-04-05 18:53:15.972201: W tensorflow/core/common_runtime/colocation_graph.cc:1218] Failed to place the graph without changing the devices of some resources. Some of the operations (that had to be colocated with resource generating operations) are not supported on the resources&#39; devices. Current candidate devices are [
  /job:localhost/replica:0/task:0/device:CPU:0].
See below for details of this colocation group:
Colocation Debug Info:
Colocation group had the following types and supported devices:
Root Member(assigned_device_name_index_=-1 requested_device_name_=&#39;/device:GPU:0&#39; assigned_device_name_=&#39;&#39; resource_device_name_=&#39;/device:GPU:0&#39; supported_device_types_=[CPU] possible_devices_=[]
ReadVariableOp: GPU CPU
VarHandleOp: CPU

Colocation members, user-requested devices, and framework assigned devices, if any:
  retrieval_model/sequential_block_20/item_id (VarHandleOp) /gpu:0
  retrieval_model/sequential_block_20/item_id/Read/ReadVariableOp (ReadVariableOp) /gpu:0

2022-04-05 18:53:15.972306: I tensorflow/cc/saved_model/loader.cc:212] Restoring SavedModel bundle.
2022-04-05 18:53:16.051512: I tensorflow/cc/saved_model/loader.cc:196] Running initialization op on SavedModel bundle at path: /Merlin/examples/Deploying-multi-stage-RecSys/poc_ensemble/1_predicttensorflow/1/model.savedmodel
2022-04-05 18:53:16.076336: I tensorflow/cc/saved_model/loader.cc:303] SavedModel load for tags { serve }; Status: success: OK. Took 162361 microseconds.
I0405 18:53:16.076597 12809 model_repository_manager.cc:1149] successfully loaded &#39;1_predicttensorflow&#39; version 1
I0405 18:53:16.079944 12809 tensorflow.cc:2276] TRITONBACKEND_ModelInitialize: 5_predicttensorflow (version 1)
I0405 18:53:16.082241 12809 model_inst_state.hpp:64] Loading TritonPythonnModel from model.py in path &#39;/Merlin/examples/Deploying-multi-stage-RecSys/poc_ensemble/2_queryfaiss/1&#39;
/systems/merlin/systems/dag/ops/feast.py:15: DeprecationWarning: `np.float` is a deprecated alias for the builtin `float`. To silence this warning, use `float` by itself. Doing this will not modify any behavior and is safe. If you specifically wanted the numpy scalar type, use `np.float64` here.
Deprecated in NumPy 1.20; for more details and guidance: https://numpy.org/devdocs/release/1.20.0-notes.html#deprecations
  ValueType.FLOAT: (np.float, False, False),
/usr/local/lib/python3.8/dist-packages/faiss/loader.py:28: DeprecationWarning: distutils Version classes are deprecated. Use packaging.version instead.
  if LooseVersion(numpy.__version__) &gt;= &#34;1.19&#34;:
/usr/local/lib/python3.8/dist-packages/setuptools/_distutils/version.py:351: DeprecationWarning: distutils Version classes are deprecated. Use packaging.version instead.
  other = LooseVersion(other)
04/05/2022 06:53:16 PM INFO:Loading faiss with AVX2 support.
04/05/2022 06:53:16 PM INFO:Could not load library with AVX2 support due to:
ModuleNotFoundError(&#34;No module named &#39;faiss.swigfaiss_avx2&#39;&#34;)
04/05/2022 06:53:16 PM INFO:Loading faiss.
04/05/2022 06:53:16 PM INFO:Successfully loaded faiss.
I0405 18:53:16.110800 12809 model_inst_state.hpp:64] Loading TritonPythonnModel from model.py in path &#39;/Merlin/examples/Deploying-multi-stage-RecSys/poc_ensemble/3_queryfeast/1&#39;
I0405 18:53:16.111056 12809 model_repository_manager.cc:1149] successfully loaded &#39;2_queryfaiss&#39; version 1
I0405 18:53:16.119599 12809 model_repository_manager.cc:1149] successfully loaded &#39;3_queryfeast&#39; version 1
I0405 18:53:16.124341 12809 model_inst_state.hpp:64] Loading TritonPythonnModel from model.py in path &#39;/Merlin/examples/Deploying-multi-stage-RecSys/poc_ensemble/4_unrollfeatures/1&#39;
I0405 18:53:16.126394 12809 tensorflow.cc:2325] TRITONBACKEND_ModelInstanceInitialize: 5_predicttensorflow (GPU device 0)
I0405 18:53:16.126561 12809 model_repository_manager.cc:1149] successfully loaded &#39;4_unrollfeatures&#39; version 1
2022-04-05 18:53:16.127020: I tensorflow/cc/saved_model/reader.cc:43] Reading SavedModel from: /Merlin/examples/Deploying-multi-stage-RecSys/poc_ensemble/5_predicttensorflow/1/model.savedmodel
2022-04-05 18:53:16.148400: I tensorflow/cc/saved_model/reader.cc:107] Reading meta graph with tags { serve }
2022-04-05 18:53:16.148442: I tensorflow/cc/saved_model/reader.cc:148] Reading SavedModel debug info (if present) from: /Merlin/examples/Deploying-multi-stage-RecSys/poc_ensemble/5_predicttensorflow/1/model.savedmodel
2022-04-05 18:53:16.150520: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1525] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 13584 MB memory:  -&gt; device: 0, name: Quadro GV100, pci bus id: 0000:15:00.0, compute capability: 7.0
2022-04-05 18:53:16.176360: I tensorflow/cc/saved_model/loader.cc:212] Restoring SavedModel bundle.
2022-04-05 18:53:16.330717: I tensorflow/cc/saved_model/loader.cc:196] Running initialization op on SavedModel bundle at path: /Merlin/examples/Deploying-multi-stage-RecSys/poc_ensemble/5_predicttensorflow/1/model.savedmodel
2022-04-05 18:53:16.383740: I tensorflow/cc/saved_model/loader.cc:303] SavedModel load for tags { serve }; Status: success: OK. Took 256733 microseconds.
I0405 18:53:16.383873 12809 model_inst_state.hpp:64] Loading TritonPythonnModel from model.py in path &#39;/Merlin/examples/Deploying-multi-stage-RecSys/poc_ensemble/6_softmaxsampling/1&#39;
I0405 18:53:16.383965 12809 model_repository_manager.cc:1149] successfully loaded &#39;5_predicttensorflow&#39; version 1
I0405 18:53:16.385192 12809 model_repository_manager.cc:1149] successfully loaded &#39;6_softmaxsampling&#39; version 1
I0405 18:53:16.389471 12809 model_repository_manager.cc:994] loading: ensemble_model:1
I0405 18:53:16.490208 12809 model_repository_manager.cc:1149] successfully loaded &#39;ensemble_model&#39; version 1
I0405 18:53:16.490451 12809 server.cc:522]
+------------------+------+
| Repository Agent | Path |
+------------------+------+
+------------------+------+

I0405 18:53:16.490576 12809 server.cc:549]
+------------+-----------------------------------------------------------------+-----------------------------+
| Backend    | Path                                                            | Config                      |
+------------+-----------------------------------------------------------------+-----------------------------+
| tensorflow | /opt/tritonserver/backends/tensorflow2/libtriton_tensorflow2.so | {&#34;cmdline&#34;:{&#34;version&#34;:&#34;2&#34;}} |
| nvtabular  | /opt/tritonserver/backends/nvtabular/libtriton_nvtabular.so     | {}                          |
+------------+-----------------------------------------------------------------+-----------------------------+

I0405 18:53:16.490758 12809 server.cc:592]
+---------------------+---------+--------+
| Model               | Version | Status |
+---------------------+---------+--------+
| 0_queryfeast        | 1       | READY  |
| 1_predicttensorflow | 1       | READY  |
| 2_queryfaiss        | 1       | READY  |
| 3_queryfeast        | 1       | READY  |
| 4_unrollfeatures    | 1       | READY  |
| 5_predicttensorflow | 1       | READY  |
| 6_softmaxsampling   | 1       | READY  |
| ensemble_model      | 1       | READY  |
+---------------------+---------+--------+

I0405 18:53:16.546009 12809 metrics.cc:623] Collecting metrics for GPU 0: Quadro GV100
I0405 18:53:16.546474 12809 tritonserver.cc:1932]
+----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Option                           | Value                                                                                                                                                                                        |
+----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| server_id                        | triton                                                                                                                                                                                       |
| server_version                   | 2.19.0                                                                                                                                                                                       |
| server_extensions                | classification sequence model_repository model_repository(unload_dependents) schedule_policy model_configuration system_shared_memory cuda_shared_memory binary_tensor_data statistics trace |
| model_repository_path[0]         | /Merlin/examples/Deploying-multi-stage-RecSys/poc_ensemble                                                                                                                                   |
| model_control_mode               | MODE_NONE                                                                                                                                                                                    |
| strict_model_config              | 1                                                                                                                                                                                            |
| rate_limit                       | OFF                                                                                                                                                                                          |
| pinned_memory_pool_byte_size     | 268435456                                                                                                                                                                                    |
| cuda_memory_pool_byte_size{0}    | 67108864                                                                                                                                                                                     |
| response_cache_byte_size         | 0                                                                                                                                                                                            |
| min_supported_compute_capability | 6.0                                                                                                                                                                                          |
| strict_readiness                 | 1                                                                                                                                                                                            |
| exit_timeout                     | 30                                                                                                                                                                                           |
+----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

I0405 18:53:16.547652 12809 grpc_server.cc:4375] Started GRPCInferenceService at 0.0.0.0:8001
I0405 18:53:16.548288 12809 http_server.cc:3075] Started HTTPService at 0.0.0.0:8000
I0405 18:53:16.590481 12809 http_server.cc:178] Started Metrics Service at 0.0.0.0:8002
I0405 18:53:22.789904 12809 server.cc:252] Waiting for in-flight requests to complete.
I0405 18:53:22.789934 12809 model_repository_manager.cc:1026] unloading: ensemble_model:1
I0405 18:53:22.790047 12809 model_repository_manager.cc:1026] unloading: 6_softmaxsampling:1
I0405 18:53:22.790157 12809 model_repository_manager.cc:1026] unloading: 5_predicttensorflow:1
I0405 18:53:22.790212 12809 model_repository_manager.cc:1132] successfully unloaded &#39;ensemble_model&#39; version 1
I0405 18:53:22.790326 12809 model_repository_manager.cc:1026] unloading: 4_unrollfeatures:1I0405 18:53:22.790324 12809 backend.cc:160] TRITONBACKEND_ModelInstanceFinalize: delete instance state

Signal (11) received.
I0405 18:53:22.790397 12809 model_repository_manager.cc:1026] unloading: 3_queryfeast:1
I0405 18:53:22.790436 12809 model_repository_manager.cc:1026] unloading: 2_queryfaiss:1
I0405 18:53:22.790500 12809 tensorflow.cc:2363] TRITONBACKEND_ModelInstanceFinalize: delete instance state
I0405 18:53:22.790501 12809 backend.cc:160] TRITONBACKEND_ModelInstanceFinalize: delete instance stateI0405 18:53:22.790543 12809 backend.cc:160] TRITONBACKEND_ModelInstanceFinalize: delete instance state

Signal (11) received.
Signal (11) received.
I0405 18:53:22.790619 12809 model_repository_manager.cc:1026] unloading: 1_predicttensorflow:1
I0405 18:53:22.790695 12809 model_repository_manager.cc:1026] unloading: 0_queryfeast:1
I0405 18:53:22.790803 12809 server.cc:267] Timeout 30: Found 7 live models and 0 in-flight non-inference requests
I0405 18:53:22.790697 12809 tensorflow.cc:2302] TRITONBACKEND_ModelFinalize: delete model state
I0405 18:53:22.791279 12809 backend.cc:160] TRITONBACKEND_ModelInstanceFinalize: delete instance state
Signal (11) received.
I0405 18:53:22.791393 12809 tensorflow.cc:2363] TRITONBACKEND_ModelInstanceFinalize: delete instance state
I0405 18:53:22.818461 12809 backend.cc:160] TRITONBACKEND_ModelInstanceFinalize: delete instance state
Signal (11) received.
I0405 18:53:22.847960 12809 tensorflow.cc:2302] TRITONBACKEND_ModelFinalize: delete model state
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Signal (2) received.
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
I0405 18:53:23.800413 12809 server.cc:267] Timeout 29: Found 7 live models and 0 in-flight non-inference requests
I0405 18:53:24.811206 12809 server.cc:267] Timeout 28: Found 7 live models and 0 in-flight non-inference requests
 0# 0x0000555EA4C27299 in /opt/tritonserver/bin/tritonserver
 1# 0x00007FD58C687210 in /usr/lib/x86_64-linux-gnu/libc.so.6
 2# 0x00007FD531CF2F2E in /usr/lib/x86_64-linux-gnu/libpython3.8.so.1.0
 3# TRITONBACKEND_ModelInstanceFinalize in /opt/tritonserver/backends/nvtabular/libtriton_nvtabular.so
 4# 0x00007FD58D224FC4 in /opt/tritonserver/bin/../lib/libtritonserver.so
 5# 0x00007FD58D21E3B9 in /opt/tritonserver/bin/../lib/libtritonserver.so
 6# 0x00007FD58D21EB1D in /opt/tritonserver/bin/../lib/libtritonserver.so
 7# 0x00007FD58D0A20D7 in /opt/tritonserver/bin/../lib/libtritonserver.so
 8# 0x00007FD58CA75DE4 in /usr/lib/x86_64-linux-gnu/libstdc++.so.6
 9# 0x00007FD58CEF3609 in /usr/lib/x86_64-linux-gnu/libpthread.so.0
10# clone in /usr/lib/x86_64-linux-gnu/libc.so.6

</pre></div></div>
</div>
<p>Convert our response to a numpy array and print it out.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output</span><span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">as_numpy</span><span class="p">(</span><span class="s1">&#39;ordered_ids&#39;</span><span class="p">)</span>
<span class="n">output</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([[ 392],
       [ 267],
       [1107],
       [ 968],
       [ 457],
       [ 750],
       [ 669],
       [ 789],
       [1237],
       [1164]], dtype=int32)
</pre></div></div>
</div>
<p>Note that these item ids are encoded values, not the raw original values. We will eventually create the reverse dictionary lookup functionality to be able to map these encoded item ids to their original raw ids with one-line of code. But if you really want to do it now, you can easily map these ids to their original values using the <code class="docutils literal notranslate"><span class="pre">unique.item_id.parquet</span></code> file stored in the <code class="docutils literal notranslate"><span class="pre">categories</span></code> folder.</p>
<p>That’s it! You finished deploying a multi-stage Recommender Systems on Triton Inference Server using Merlin framework.</p>
</div>
</div>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, NVIDIA.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>