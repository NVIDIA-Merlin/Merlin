<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ranking script &mdash; Merlin  documentation</title><link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/mystnb.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/togglebutton.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/custom.css" type="text/css" />
    <link rel="canonical" href="https://nvidia-merlin.github.io/Merlin/main/examples/quick_start/scripts/ranking/index.html" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script >let toggleHintShow = 'Click to show';</script>
        <script >let toggleHintHide = 'Click to hide';</script>
        <script >let toggleOpenOnPrint = 'true';</script>
        <script src="../../../../_static/togglebutton.js"></script>
        <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">
  <div class="banner">
    <p class="banner">
      Beginning in January 2023, versions for all NVIDIA Merlin projects
      will change from semantic versioning like <code>4.0</code>
      to calendar versioning like <code>23.01</code>.</p>
  </div>

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            Merlin
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../README.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../guide/recommender_system_guide.html">Recommender System Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Example Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../containers.html">Merlin Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../support_matrix/index.html">Merlin Support Matrix</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Merlin</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Ranking script</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="ranking-script">
<h1>Ranking script<a class="headerlink" href="#ranking-script" title="Permalink to this headline"></a></h1>
<p>The <code class="docutils literal notranslate"><span class="pre">ranking.py</span></code> is a template script that leverages the Merlin <a class="reference external" href="https://github.com/NVIDIA-Merlin/models/">models</a> library (Tensorflow API) to build, train, evaluate ranking models. In the end you can either save the model for interence or persist model predictions to file.</p>
<p>Merlin models library provides building blocks on top of Tensorflow (Keras) that make it easy to build and train advanced neural ranking models. There are blocks for representing input, configuring model outputs/heads, perform feature interactions, losses, metrics, negative sampling, among others.</p>
<div class="section" id="ranking-in-multi-stage-recsys">
<h2>Ranking in multi-stage RecSys<a class="headerlink" href="#ranking-in-multi-stage-recsys" title="Permalink to this headline"></a></h2>
<p>Large online services like social media, streaming, e-commerce, and news provide a very broad catalog of items and leverage recommender systems to help users find relevant items. Those companies typically deploy recommender systems pipelines with <a class="reference external" href="https://medium.com/nvidia-merlin/recommender-systems-not-just-recommender-models-485c161c755e">multiple stages</a>, in particular the retrieval and ranking. The retrieval stage selects a few hundreds or thousands of items from a large catalog. It can be a heuristic approach (like most recent items) or a scalable model like Matrix Factorization, <a class="reference external" href="https://medium.com/nvidia-merlin/scale-faster-with-less-code-using-two-tower-with-merlin-c16f32aafa9f">Two-Tower architecture</a> or <a class="reference external" href="https://static.googleusercontent.com/media/research.google.com/pt-BR//pubs/archive/45530.pdf">YouTubeDNN</a>. Then, the ranking stage scores the relevance of the candidate items provided by the previous stage for a given user and context.</p>
</div>
<div class="section" id="multi-task-learning-for-ranking-models">
<h2>Multi-task learning for ranking models<a class="headerlink" href="#multi-task-learning-for-ranking-models" title="Permalink to this headline"></a></h2>
<p>It is common to find scenarios where you need to score the likelihood of different user-item events, e.g., clicking, liking, sharing, commenting, following the author, etc. Multi-Task Learning (MTL) techniques have been popular in deep learning to train a single model that is able to predict multiple targets at the same time.</p>
<p>By using MTL, it is typically possible to improve the tasks accuracy for somewhat correlated tasks, in particular for sparser targets, for which less training data is available. And instead of spending computational resources to train and deploy different models for each task, you can train and deploy a single MTL model that is able to predict multiple targets.</p>
<p>You can find more details in this <a class="reference external" href="https://medium.com/nvidia-merlin/building-ranking-models-powered-by-multi-task-learning-with-merlin-and-tensorflow-4b4f993f7cc3">post</a> on the multi-task learning building blocks provided by <a class="reference external" href="https://github.com/NVIDIA-Merlin/models/">models</a>  library.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">ranking.py</span></code> script makes it easy to use multi-task learning backed by models library. It is automatically enabled when you provide more than one target column to <code class="docutils literal notranslate"><span class="pre">--tasks</span></code> argument.</p>
</div>
<div class="section" id="supported-models">
<h2>Supported models<a class="headerlink" href="#supported-models" title="Permalink to this headline"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">ranking.py</span></code> script makes it easy to use baseline and advanced deep ranking models available in <a class="reference external" href="https://github.com/NVIDIA-Merlin/models/">models</a> library.<br />
The script can be also used as an <strong>advanced example</strong> that demonstrate <a class="reference download internal" download="" href="../../../../_downloads/c410a7b00dade3a5142db45db44b30ca/ranking_models.py"><span class="xref download myst">how to set specific hyperparameters using models API</span></a>.</p>
<div class="section" id="baseline-ranking-architectures">
<h3>Baseline ranking architectures<a class="headerlink" href="#baseline-ranking-architectures" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p><strong>MLP</strong> (<code class="docutils literal notranslate"><span class="pre">--model=mlp</span></code>)  - Simple multi-layer perceptron architecture. More info in <a class="reference external" href="https://nvidia-merlin.github.io/models/main/generated/merlin.models.tf.MLPBlock.html#merlin.models.tf.MLPBlock">MLPBlock</a>.</p></li>
<li><p><strong>Wide and Deep</strong> - Aims to leverage the ability of neural networks to generalize and capacity of linear models to memorize relevant feature interactions. The deep part is an MLP model, with categorical features represented as embeddings, which are concatenated with continuous features and fed through multiple MLP layers. The wide part is a linear model takes a sparse representation of categorical features (i.e. one-hot or multi-hot representation). More info in <a class="reference external" href="https://nvidia-merlin.github.io/models/main/generated/merlin.models.tf.WideAndDeepModel.html#merlin.models.tf.WideAndDeepModel">WideAndDeepModel</a> and its  <a class="reference external" href="https://dl.acm.org/doi/10.1145/2988450.2988454">paper</a>.</p></li>
<li><p><strong>DeepFM</strong> (<code class="docutils literal notranslate"><span class="pre">--model=deepfm</span></code>) - DeepFM architecture is a combination of a Factorization Machine and a Deep Neural Network. More info in <a class="reference external" href="https://nvidia-merlin.github.io/models/main/generated/merlin.models.tf.DeepFMModel.html#merlin.models.tf.DeepFMModel">DeepFMModel</a> and its <a class="reference external" href="https://arxiv.org/abs/1703.04247">paper</a>.</p></li>
<li><p><strong>DRLM</strong> (<code class="docutils literal notranslate"><span class="pre">--model=dlrm</span></code>) - Continuous features are concatenated and combined by the bottom MLP to produce an embedding like categorical embeddings. The factorization machines layer perform 2nd level feature interaction of those embeddings, which need to have the same dim.  Then those outputs are concatenated and processed through the top MLP layer to output the predictions. More info in <a class="reference external" href="https://nvidia-merlin.github.io/models/main/generated/merlin.models.tf.DLRMModel.html#merlin.models.tf.DLRMModel">DLRMModel</a> and its <a class="reference external" href="https://arxiv.org/abs/1906.00091">paper</a>.</p></li>
<li><p><strong>DCN-v2</strong> (<code class="docutils literal notranslate"><span class="pre">--model=dcn</span></code>) - The Improved Deep &amp; Cross Network combines a MLP network with cross-network for powerful and bounded feature interaction. More info in <a class="reference external" href="https://nvidia-merlin.github.io/models/main/generated/merlin.models.tf.DCNModel.html#merlin.models.tf.DCNModel">DCNModel</a> and its <a class="reference external" href="https://dl.acm.org/doi/10.1145/3442381.3450078">paper</a>.</p></li>
</ul>
</div>
<div class="section" id="multi-task-learning-architectures">
<h3>Multi-task learning architectures<a class="headerlink" href="#multi-task-learning-architectures" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p><strong>MMOE</strong> (<code class="docutils literal notranslate"><span class="pre">--model=mmoe</span></code>) - The Multi-gate Mixture-of-Experts (MMoE) is one of the most popular models for multi-task learning on tabular data. It allows parameters to be automatically allocated to capture either shared task information or task-specific information. The core components of MMoE are experts and gates. Instead of using a shared-bottom for all tasks, it has multiple expert sub-networks processing input features independently from each other. Each task has an independent gate, which dynamically selects based on the inputs the level with which the task wants to leverage the output of each expert. More info on <a class="reference external" href="https://nvidia-merlin.github.io/models/main/generated/merlin.models.tf.MMOEBlock.html#merlin.models.tf.MMOEBlock">MMOEBlock</a> and its <a class="reference external" href="https://dl.acm.org/doi/pdf/10.1145/3219819.3220007">paper</a>.</p></li>
<li><p><strong>CGC</strong> (<code class="docutils literal notranslate"><span class="pre">--model=cgc</span></code>) - Instead of having tasks sharing all the experts like in MMOE, it allows for splitting task-specific experts and shared experts, in an architecture named Customized Gate Control (CGC) Model. More info on <a class="reference external" href="https://nvidia-merlin.github.io/models/main/generated/merlin.models.tf.CGCBlock.html#merlin.models.tf.CGCBlock">CGCBlock</a> and its <a class="reference external" href="https://dl.acm.org/doi/10.1145/3383313.3412236">paper</a>.</p></li>
<li><p><strong>PLE</strong> (<code class="docutils literal notranslate"><span class="pre">--model=ple</span></code>) - In the same paper introducing CGC, authors proposed stacking multiple CGC models on top of each other to form a multi-level MTL model, so that the model can progressively combine shared and task-specific experts. They name this approach as Progressive Layered Extraction (PLE). Their paper experiments showed accuracy improvements by using PLE compared to CGC. More info on <a class="reference external" href="https://nvidia-merlin.github.io/models/main/generated/merlin.models.tf.CGCBlock.html#merlin.models.tf.CGCBlock">PLEBlock</a> and its <a class="reference external" href="https://dl.acm.org/doi/10.1145/3383313.3412236">paper</a>.</p></li>
</ul>
<center>
<img src="https://miro.medium.com/v2/resize:fit:720/0*Fo6rIr10IJQCB6sb" alt="Multi-task learning architectures" >
</center>
</div>
</div>
<div class="section" id="best-practices">
<h2>Best practices<a class="headerlink" href="#best-practices" title="Permalink to this headline"></a></h2>
<div class="section" id="modeling-inputs-features">
<h3>Modeling inputs features<a class="headerlink" href="#modeling-inputs-features" title="Permalink to this headline"></a></h3>
<p>Neural networks operate on top of dense / continuous float inputs. Continuous features fit nicely into that format, but categorical features needs to be represented accordingly.
It is assumed that in the preprocessing the categorical features were encoded as contiguous ids. Then, they are typically be represented by the model using:</p>
<ul class="simple">
<li><p><strong>One-hot encoding</strong> Sparse representation where each categorical value is represented by a binary feature with 1 only for the actual value. If the categorical feature contains a list of values, it can be encoded with multi-hot encoding, with 1s for all values in the list. This encoding is useful to represent low-cardinality categorical features or to provide input to linear models.</p></li>
<li><p><strong>Embedding</strong> - This encoding is very popular for deep neural networks. Each categorical value is mapped to a 1D continuous vector, that can be trainable or pre-trained. The embeddings are stored in embedding layers or tables, whose first dim in the cardinality of the categorical feature and 2nd dim is the embedding size.</p></li>
</ul>
<div class="section" id="dealing-with-high-cardinality-categorical-features">
<h4><strong>Dealing with high-cardinality categorical features</strong><a class="headerlink" href="#dealing-with-high-cardinality-categorical-features" title="Permalink to this headline"></a></h4>
<p>We explain in the <span class="xref myst">Quick-start preprocessing documentation</span> that large services might have categorical features with very high cardinality (e.g. order of hundreds of millions or higher), like user id or item id. They typically require a high memory to be stored (e.g. with embedding tables) or processed (e.g. with one-hot encoding). In addition, most of the categorical values are very infrequent, for which it is not possible to learn good embeddings.</p>
<p>The <span class="xref myst">preprocessing documentation</span> describes some options to deal with the high-cardinality features: <strong>Frequency capping</strong>, <strong>Filtering out rows with infrequent values</strong> and  <strong>Hashing</strong>.</p>
<p>You might also decide to keep the original high-cardinality of the categorical features for better personalization level and accuracy.</p>
<blockquote>
<div><p>The embedding tables are typically responsible for most of the parameters of Recommender System models. For large scale systems, where the number of users and items is in the order of hundreds of millions, it is typically needed to use a distributed embeddings solution, so that embedding embedding tables can be sharded in multiple compute devices (e.g. GPU, CPU).</p>
</div></blockquote>
<!--**TODO**: Add references to NVIDIA distributed embeddings solutions -->
</div>
<div class="section" id="defining-the-embedding-size">
<h4><strong>Defining the embedding size</strong><a class="headerlink" href="#defining-the-embedding-size" title="Permalink to this headline"></a></h4>
<p>It is common sense that higher the cardinality of categorical feature the higher should be the embedding dimension, as its vector space gets more complex.</p>
<p>Models library uses by default a heuristic method that sets embedding sizes based on cardinality (implementation <a class="reference external" href="https://github.com/NVIDIA-Merlin/models/blob/a5e392cbc575fe984c96ddcbce696e4b71b7073d/merlin/models/utils/schema_utils.py#L169">here</a>), which can be scaled by <code class="docutils literal notranslate"><span class="pre">--embedding_sizes_multiplier</span></code>. Models library API also allows setting <a class="reference external" href="https://nvidia-merlin.github.io/models/main/generated/merlin.models.tf.Embeddings.html#merlin.models.tf.Embeddings">specific embedding dims</a> for each / all categorical features.</p>
<blockquote>
<div><p>Some models supported by this script (DLRM and DeepFM) require the embedding sizes of categorical features to be the same (<code class="docutils literal notranslate"><span class="pre">--embedding_dim</span></code>) because of their feature interaction approach based on Factorization Machines.</p>
</div></blockquote>
</div>
</div>
<div class="section" id="regularization">
<h3>Regularization<a class="headerlink" href="#regularization" title="Permalink to this headline"></a></h3>
<p>Neural networks typically require regularization in order to avoid overfitting, in particular if trained on small data or for many epochs that can make it memorize train set. This script provide typical regularization techniques like Dropout (<code class="docutils literal notranslate"><span class="pre">--dropout</span></code>) and L2 regularization of model parameters (<code class="docutils literal notranslate"><span class="pre">--l2_reg</span></code>) and embeddings (<code class="docutils literal notranslate"><span class="pre">--embeddings_l2_reg</span></code>).</p>
</div>
<div class="section" id="classes-weights">
<h3>Classes weights<a class="headerlink" href="#classes-weights" title="Permalink to this headline"></a></h3>
<p>Typically positive user interactions are just a small fraction of the items that were exposed to the users. That leads to class unbalanced targets.<br />
A common technique to deal with this problem in machine learning is to assign a higher weight to the loss for examples with infrequent targets - positive classes in this case.<br />
You might set the positive class weight for single-task learning models with <code class="docutils literal notranslate"><span class="pre">--stl_positive_class_weight</span></code> and for multi-task learning you can set the class weight for each target separately by using <code class="docutils literal notranslate"><span class="pre">--mtl_pos_class_weight_*</span></code>, where <code class="docutils literal notranslate"><span class="pre">*</span></code> must be replaced by the target name. In this case, the negative class weight is always 1.0.</p>
</div>
<div class="section" id="negative-sampling">
<h3>Negative sampling<a class="headerlink" href="#negative-sampling" title="Permalink to this headline"></a></h3>
<p>If you have only positive interactions in your training data, you can use negative sampling to include synthetic negative examples in the training batch. The negative samples are generated by adding for each positive example N negative examples, keeping user features and replacing features of the target item by other item interacted by another users in the batch. You can easily set the number of negative examples for train (<code class="docutils literal notranslate"><span class="pre">--in_batch_negatives_train</span></code>) and evaluate (<code class="docutils literal notranslate"><span class="pre">--in_batch_negatives_eval</span></code>).<br />
This functionality require that user and item features are tagged accordingly, as explained in the <span class="xref myst">Quick-start preprocessing documentation</span>.</p>
</div>
<div class="section" id="multi-task-learning">
<h3>Multi-task learning<a class="headerlink" href="#multi-task-learning" title="Permalink to this headline"></a></h3>
<div class="section" id="losses-weights">
<h4><strong>Losses weights</strong><a class="headerlink" href="#losses-weights" title="Permalink to this headline"></a></h4>
<p>You can balance the learning of the multiple tasks by setting losses weights when using multi-task learning. You can set them by providing <code class="docutils literal notranslate"><span class="pre">--mtl_loss_weight_*</span></code> for each task, where <code class="docutils literal notranslate"><span class="pre">*</span></code> must be replaced by the target name.</p>
</div>
<div class="section" id="setting-tasks-sample-space">
<h4><strong>Setting tasks sample space</strong><a class="headerlink" href="#setting-tasks-sample-space" title="Permalink to this headline"></a></h4>
<p>Some targets might depend on other target columns for some datasets. For example, the preprocessed TenRec dataset have positive (=1) <code class="docutils literal notranslate"><span class="pre">like</span></code>, <code class="docutils literal notranslate"><span class="pre">follow</span></code>, and <code class="docutils literal notranslate"><span class="pre">share</span></code> events only if the user has also clicked on the item (<code class="docutils literal notranslate"><span class="pre">click=1</span></code>).</p>
<p>You might want to model dependent tasks explicitly by setting the sample space, i.e., computing the loss of the dependent tasks only for examples where the dominant target is 1. That would make the dependent targets less sparser, as their value is always 0 when dominant target is 0.</p>
<p>The scripts allows setting the tasks sample space by using <code class="docutils literal notranslate"><span class="pre">--tasks_sample_space</span></code>, which accepts comma-separated values. The order of sample spaces should match the order of the <code class="docutils literal notranslate"><span class="pre">--tasks</span></code>. Empty value means the task will be trained in the entire space, i.e., loss computed for all examples in the dataset.<br />
For TenRec dataset, you could use <code class="docutils literal notranslate"><span class="pre">--tasks</span> <span class="pre">click,like,share,follow</span></code> and <code class="docutils literal notranslate"><span class="pre">--tasks_sample_space=,click,click,click</span></code>, meaning that the click task will be trained using the entire space and the other tasks will be trained only in click space.</p>
<blockquote>
<div><p>We have observed empirically that if you want a model to predict all tasks at the same time (e.g. the likelihood of a user to click-like-share a post), it is better to train all tasks using entire space. On the other hand, if you want to train a MTL model that predicts rarer events (e.g. add-to-cart, purchase) given prior events (e.g. click), then you typically get better accuracy on the dependent tasks training them in the dominant task space, while training the dominant task on entire space.</p>
</div></blockquote>
</div>
</div>
</div>
<div class="section" id="command-line-arguments">
<h2>Command line arguments<a class="headerlink" href="#command-line-arguments" title="Permalink to this headline"></a></h2>
<p>In this section we describe the command line arguments of the <code class="docutils literal notranslate"><span class="pre">ranking.py</span></code> script.</p>
<blockquote>
<div><p>You can check how to <a class="reference internal" href="../../ranking.html"><span class="doc std std-doc">setup the Docker image</span></a> to run <code class="docutils literal notranslate"><span class="pre">ranking.py</span></code> script with Docker.</p>
</div></blockquote>
<p>This is an example command line for running the training for the TenRec dataset in our Docker image, which is explained <a class="reference internal" href="../../ranking.html"><span class="doc std std-doc">here</span></a>.
The parameters and their values can be separated by either space or by <code class="docutils literal notranslate"><span class="pre">=</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>/Merlin/examples/quick_start/scripts/ranking/
<span class="nv">OUT_DATASET_PATH</span><span class="o">=</span>/outputs/dataset
<span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">TF_GPU_ALLOCATOR</span><span class="o">=</span>cuda_malloc_async<span class="w"> </span>python<span class="w">  </span>ranking.py<span class="w"> </span>--train_data_path<span class="w"> </span><span class="nv">$OUT_DATASET_PATH</span>/train<span class="w"> </span>--eval_data_path<span class="w"> </span><span class="nv">$OUT_DATASET_PATH</span>/eval<span class="w"> </span>--output_path<span class="w"> </span>./outputs/<span class="w"> </span>--tasks<span class="o">=</span>click<span class="w"> </span>--stl_positive_class_weight<span class="w"> </span><span class="m">3</span><span class="w"> </span>--model<span class="w"> </span>dlrm<span class="w"> </span>--embeddings_dim<span class="w"> </span><span class="m">64</span><span class="w"> </span>--l2_reg<span class="w"> </span>1e-4<span class="w"> </span>--embeddings_l2_reg<span class="w"> </span>1e-6<span class="w"> </span>--dropout<span class="w"> </span><span class="m">0</span>.05<span class="w"> </span>--mlp_layers<span class="w"> </span><span class="m">64</span>,32<span class="w">  </span>--lr<span class="w"> </span>1e-4<span class="w"> </span>--lr_decay_rate<span class="w"> </span><span class="m">0</span>.99<span class="w"> </span>--lr_decay_steps<span class="w"> </span><span class="m">100</span><span class="w"> </span>--train_batch_size<span class="w"> </span><span class="m">65536</span><span class="w"> </span>--eval_batch_size<span class="w"> </span><span class="m">65536</span><span class="w"> </span>--epochs<span class="w"> </span><span class="m">1</span><span class="w"> </span>--save_model_path<span class="w"> </span>./saved_model
</pre></div>
</div>
<div class="section" id="inputs">
<h3>Inputs<a class="headerlink" href="#inputs" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">--</span><span class="n">train_data_path</span>
                        <span class="n">Path</span> <span class="n">of</span> <span class="n">the</span> <span class="n">train</span> <span class="nb">set</span><span class="o">.</span> <span class="n">It</span> <span class="n">expects</span> <span class="n">a</span> <span class="n">folder</span> <span class="k">with</span> <span class="n">parquet</span> <span class="n">files</span><span class="o">.</span>
                        <span class="n">If</span> <span class="ow">not</span> <span class="n">provided</span><span class="p">,</span> <span class="n">the</span> <span class="n">model</span> <span class="n">will</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">trained</span> <span class="p">(</span><span class="ow">in</span> <span class="n">case</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">use</span>
                        <span class="o">--</span><span class="n">load_model_path</span> <span class="n">to</span> <span class="n">load</span> <span class="n">a</span> <span class="n">pre</span><span class="o">-</span><span class="n">trained</span> <span class="n">model</span><span class="p">)</span>
  <span class="o">--</span><span class="n">eval_data_path</span>
                        <span class="n">Path</span> <span class="n">of</span> <span class="n">the</span> <span class="nb">eval</span> <span class="nb">set</span><span class="o">.</span> <span class="n">It</span> <span class="n">expects</span> <span class="n">a</span> <span class="n">folder</span> <span class="k">with</span> <span class="n">parquet</span> <span class="n">files</span><span class="o">.</span>
                        <span class="n">If</span> <span class="ow">not</span> <span class="n">provided</span><span class="p">,</span> <span class="n">the</span> <span class="n">model</span> <span class="n">will</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">evaluated</span>
  <span class="o">--</span><span class="n">predict_data_path</span>
                        <span class="n">Path</span> <span class="n">of</span> <span class="n">a</span> <span class="n">dataset</span> <span class="k">for</span> <span class="n">prediction</span><span class="o">.</span> <span class="n">It</span> <span class="n">expects</span> <span class="n">a</span> <span class="n">folder</span> <span class="k">with</span> <span class="n">parquet</span> <span class="n">files</span>
                        <span class="n">If</span> <span class="n">provided</span><span class="p">,</span> <span class="n">it</span> <span class="n">will</span> <span class="n">compute</span> <span class="n">the</span> <span class="n">predictions</span> <span class="k">for</span> <span class="n">this</span> <span class="n">dataset</span> <span class="ow">and</span>
                        <span class="n">save</span> <span class="n">those</span> <span class="n">predictions</span> <span class="n">to</span> <span class="o">--</span><span class="n">predict_output_path</span>
  <span class="o">--</span><span class="n">load_model_path</span>     
                        <span class="n">If</span> <span class="n">provided</span><span class="p">,</span> <span class="n">loads</span> <span class="n">a</span> <span class="n">model</span> <span class="n">saved</span> <span class="n">by</span> <span class="o">--</span><span class="n">save_model_path</span>
                        <span class="n">instead</span> <span class="n">of</span> <span class="n">initializing</span> <span class="n">the</span> <span class="n">parameters</span> <span class="n">randomly</span>
</pre></div>
</div>
</div>
<div class="section" id="tasks">
<h3>Tasks<a class="headerlink" href="#tasks" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">--</span><span class="n">tasks</span>               <span class="n">Columns</span> <span class="p">(</span><span class="n">comma</span><span class="o">-</span><span class="n">sep</span><span class="p">)</span> <span class="k">with</span> <span class="n">the</span> <span class="n">target</span> <span class="n">columns</span> <span class="n">to</span>
                        <span class="n">be</span> <span class="n">predicted</span><span class="o">.</span> <span class="n">A</span> <span class="n">regression</span><span class="o">/</span><span class="n">binary</span> <span class="n">classification</span>
                        <span class="n">head</span> <span class="ow">is</span> <span class="n">created</span> <span class="k">for</span> <span class="n">each</span> <span class="n">of</span> <span class="n">the</span> <span class="n">target</span> <span class="n">columns</span><span class="o">.</span>
                        <span class="n">If</span> <span class="n">more</span> <span class="n">than</span> <span class="n">one</span> <span class="n">column</span> <span class="ow">is</span> <span class="n">provided</span><span class="p">,</span> <span class="n">then</span> <span class="n">multi</span><span class="o">-</span>
                        <span class="n">task</span> <span class="n">learning</span> <span class="ow">is</span> <span class="n">used</span> <span class="n">to</span> <span class="n">combine</span> <span class="n">the</span> <span class="n">tasks</span>
                        <span class="n">losses</span><span class="o">.</span> <span class="n">If</span> <span class="s1">&#39;all&#39;</span> <span class="ow">is</span> <span class="n">provided</span><span class="p">,</span> <span class="nb">all</span> <span class="n">columns</span> <span class="n">tagged</span>
                        <span class="k">as</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">schema</span> <span class="n">are</span> <span class="n">used</span> <span class="k">as</span> <span class="n">tasks</span><span class="o">.</span> <span class="n">By</span>
                        <span class="n">default</span> <span class="s1">&#39;all&#39;</span>
  <span class="o">--</span><span class="n">tasks_sample_space</span> 
                        <span class="n">Columns</span> <span class="p">(</span><span class="n">comma</span><span class="o">-</span><span class="n">sep</span><span class="p">)</span> <span class="n">to</span> <span class="n">be</span> <span class="n">used</span> <span class="k">as</span> <span class="n">sample</span> <span class="n">space</span>
                        <span class="k">for</span> <span class="n">each</span> <span class="n">task</span><span class="o">.</span> <span class="n">This</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">columns</span> <span class="n">should</span> <span class="n">match</span>
                        <span class="n">the</span> <span class="n">order</span> <span class="n">of</span> <span class="n">columns</span> <span class="ow">in</span> <span class="o">--</span><span class="n">tasks</span><span class="o">.</span> <span class="n">Typically</span> <span class="n">this</span>
                        <span class="ow">is</span> <span class="n">used</span> <span class="n">to</span> <span class="n">explicitly</span> <span class="n">model</span> <span class="n">that</span> <span class="n">the</span> <span class="n">task</span> <span class="n">event</span>
                        <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">purchase</span><span class="p">)</span> <span class="n">can</span> <span class="n">only</span> <span class="n">occur</span> <span class="n">when</span> <span class="n">another</span>
                        <span class="n">binary</span> <span class="n">event</span> <span class="n">has</span> <span class="n">already</span> <span class="n">happened</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">click</span><span class="p">)</span><span class="o">.</span>
                        <span class="n">Then</span> <span class="n">by</span> <span class="n">setting</span> <span class="k">for</span> <span class="n">example</span>
                        <span class="o">--</span><span class="n">tasks</span><span class="o">=</span><span class="n">click</span><span class="p">,</span><span class="n">purchase</span>
                        <span class="o">--</span><span class="n">tasks_sample_space</span><span class="p">,</span><span class="n">click</span><span class="p">,</span> <span class="n">you</span> <span class="n">configure</span> <span class="n">the</span>
                        <span class="n">training</span> <span class="n">to</span> <span class="n">compute</span> <span class="n">the</span> <span class="n">purchase</span> <span class="n">loss</span> <span class="n">only</span> <span class="k">for</span>
                        <span class="n">examples</span> <span class="k">with</span> <span class="n">click</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">making</span> <span class="n">the</span> <span class="n">purchase</span>
                        <span class="n">target</span> <span class="n">less</span> <span class="n">sparser</span><span class="o">.</span>
</pre></div>
</div>
</div>
<div class="section" id="model">
<h3>Model<a class="headerlink" href="#model" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">--</span><span class="n">model</span> <span class="p">{</span><span class="n">mmoe</span><span class="p">,</span><span class="n">cgc</span><span class="p">,</span><span class="n">ple</span><span class="p">,</span><span class="n">dcn</span><span class="p">,</span><span class="n">dlrm</span><span class="p">,</span><span class="n">mlp</span><span class="p">,</span><span class="n">wide_n_deep</span><span class="p">,</span><span class="n">deepfm</span><span class="p">}</span>
                        <span class="n">Types</span> <span class="n">of</span> <span class="n">ranking</span> <span class="n">model</span> <span class="n">architectures</span> <span class="n">that</span> <span class="n">are</span>
                        <span class="n">supported</span><span class="o">.</span> <span class="n">Any</span> <span class="n">of</span> <span class="n">these</span> <span class="n">models</span> <span class="n">can</span> <span class="n">be</span> <span class="n">used</span> <span class="k">with</span>
                        <span class="n">multi</span><span class="o">-</span><span class="n">task</span> <span class="n">learning</span> <span class="p">(</span><span class="n">MTL</span><span class="p">)</span><span class="o">.</span> <span class="n">But</span> <span class="n">these</span> <span class="n">three</span> <span class="n">are</span>
                        <span class="n">specific</span> <span class="n">to</span> <span class="n">MTL</span><span class="p">:</span> <span class="s1">&#39;mmoe&#39;</span><span class="p">,</span> <span class="s1">&#39;cgc&#39;</span> <span class="ow">and</span> <span class="s1">&#39;ple&#39;</span><span class="o">.</span> <span class="n">By</span> <span class="n">default</span>
                        <span class="s1">&#39;mlp&#39;</span>
  <span class="o">--</span><span class="n">activation</span> 
                        <span class="n">Activation</span> <span class="n">function</span> <span class="n">supported</span> <span class="n">by</span> <span class="n">Keras</span><span class="p">,</span> <span class="n">like</span><span class="p">:</span>
                        <span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="s1">&#39;selu&#39;</span><span class="p">,</span> <span class="s1">&#39;elu&#39;</span><span class="p">,</span> <span class="s1">&#39;tanh&#39;</span><span class="p">,</span> <span class="s1">&#39;sigmoid&#39;</span><span class="o">.</span> <span class="n">By</span>
                        <span class="n">default</span> <span class="s1">&#39;relu&#39;</span>
  <span class="o">--</span><span class="n">mlp_init</span>            <span class="n">Keras</span> <span class="n">initializer</span> <span class="k">for</span> <span class="n">MLP</span> <span class="n">layers</span><span class="o">.</span> 
                        <span class="n">By</span> <span class="n">default</span> <span class="s1">&#39;glorot_uniform&#39;</span><span class="o">.</span>
  <span class="o">--</span><span class="n">l2_reg</span>              <span class="n">L2</span> <span class="n">regularization</span> <span class="n">factor</span><span class="o">.</span> <span class="n">By</span> <span class="n">default</span> <span class="mf">1e-5</span><span class="o">.</span>
  <span class="o">--</span><span class="n">embeddings_l2_reg</span> 
                        <span class="n">L2</span> <span class="n">regularization</span> <span class="n">factor</span> <span class="k">for</span> <span class="n">embedding</span> <span class="n">tables</span><span class="o">.</span>
                        <span class="n">It</span> <span class="n">operates</span> <span class="n">only</span> <span class="n">on</span> <span class="n">the</span> <span class="n">embeddings</span> <span class="ow">in</span> <span class="n">the</span>
                        <span class="n">current</span> <span class="n">batch</span><span class="p">,</span> <span class="ow">not</span> <span class="n">on</span> <span class="n">the</span> <span class="n">whole</span> <span class="n">embedding</span> <span class="n">table</span><span class="o">.</span>
                        <span class="n">By</span> <span class="n">default</span> <span class="mf">0.0</span>
  <span class="o">--</span><span class="n">embedding_sizes_multiplier</span> 
                        <span class="n">When</span> <span class="o">--</span><span class="n">embedding_dim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">provided</span> <span class="n">it</span> <span class="n">infers</span>
                        <span class="n">automatically</span> <span class="n">the</span> <span class="n">embedding</span> <span class="n">dimensions</span> <span class="kn">from</span> <span class="nn">the</span>
                        <span class="n">categorical</span> <span class="n">features</span> <span class="n">cardinality</span><span class="o">.</span> <span class="n">This</span> <span class="n">factor</span>
                        <span class="n">allows</span> <span class="n">to</span> <span class="n">increase</span><span class="o">/</span><span class="n">decrease</span> <span class="n">the</span> <span class="n">embedding</span> <span class="n">dim</span>
                        <span class="n">based</span> <span class="n">on</span> <span class="n">the</span> <span class="n">cardinality</span><span class="o">.</span> <span class="n">Typical</span> <span class="n">values</span> <span class="nb">range</span>
                        <span class="n">between</span> <span class="mi">2</span> <span class="ow">and</span> <span class="mf">10.</span> <span class="n">By</span> <span class="n">default</span> <span class="mf">2.0</span>
  <span class="o">--</span><span class="n">dropout</span>             <span class="n">Dropout</span> <span class="n">rate</span><span class="o">.</span> <span class="n">By</span> <span class="n">default</span> <span class="mf">0.0</span>
  <span class="o">--</span><span class="n">mlp_layers</span> 
                        <span class="n">Comma</span><span class="o">-</span><span class="n">separated</span> <span class="n">dims</span> <span class="n">of</span> <span class="n">MLP</span> <span class="n">layers</span><span class="o">.</span> 
                        <span class="n">It</span> <span class="ow">is</span> <span class="n">used</span> <span class="n">by</span> <span class="n">MLP</span> <span class="n">model</span> <span class="ow">and</span> <span class="n">also</span> <span class="k">for</span> <span class="n">dense</span> <span class="n">blocks</span>
                        <span class="n">of</span> <span class="n">DLRM</span><span class="p">,</span> <span class="n">DeepFM</span><span class="p">,</span> <span class="n">DCN</span> <span class="ow">and</span> <span class="n">Wide</span><span class="o">&amp;</span><span class="n">Deep</span><span class="o">.</span>
                        <span class="n">By</span> <span class="n">default</span> <span class="s1">&#39;128,64,32&#39;</span>
  <span class="o">--</span><span class="n">stl_positive_class_weight</span> 
                        <span class="n">Positive</span> <span class="k">class</span> <span class="nc">weight</span> <span class="k">for</span> <span class="n">single</span><span class="o">-</span><span class="n">task</span>  <span class="n">models</span><span class="o">.</span> <span class="n">By</span>
                        <span class="n">default</span> <span class="mf">1.0</span><span class="o">.</span> <span class="n">The</span> <span class="n">negative</span> <span class="k">class</span> <span class="nc">weight</span> <span class="ow">is</span> <span class="n">fixed</span>
                        <span class="n">to</span> <span class="mf">1.0</span>
</pre></div>
</div>
</div>
<div class="section" id="dcn-v2">
<h3>DCN-v2<a class="headerlink" href="#dcn-v2" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">--</span><span class="n">dcn_interacted_layer_num</span>
                        <span class="n">Number</span> <span class="n">of</span> <span class="n">interaction</span> <span class="n">layers</span> <span class="k">for</span> <span class="n">DCN</span><span class="o">-</span><span class="n">v2</span>
                        <span class="n">architecture</span><span class="o">.</span> <span class="n">By</span> <span class="n">default</span> <span class="mf">1.</span>
</pre></div>
</div>
</div>
<div class="section" id="dlrm-and-deepfm">
<h3>DLRM and DeepFM<a class="headerlink" href="#dlrm-and-deepfm" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">--</span><span class="n">embeddings_dim</span> 
                        <span class="n">Sets</span> <span class="n">the</span> <span class="n">embedding</span> <span class="n">dim</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">embedding</span> <span class="n">columns</span>
                        <span class="n">to</span> <span class="n">be</span> <span class="n">the</span> <span class="n">same</span><span class="o">.</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">only</span> <span class="n">used</span> <span class="k">for</span> <span class="o">--</span><span class="n">model</span>
                        <span class="s1">&#39;dlrm&#39;</span> <span class="ow">and</span> <span class="s1">&#39;deepfm&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="wide-deep">
<h3>Wide&amp;Deep<a class="headerlink" href="#wide-deep" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">--</span><span class="n">wnd_hashed_cross_num_bins</span> 
                        <span class="n">Used</span> <span class="k">with</span> <span class="n">Wide</span><span class="o">&amp;</span><span class="n">Deep</span> <span class="n">model</span><span class="o">.</span> <span class="n">Sets</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span>
                        <span class="n">bins</span> <span class="k">for</span> <span class="n">hashing</span> <span class="n">feature</span> <span class="n">interactions</span><span class="o">.</span> <span class="n">By</span>
                        <span class="n">default</span> <span class="mf">10000.</span>
  <span class="o">--</span><span class="n">wnd_wide_l2_reg</span> 
                        <span class="n">Used</span> <span class="k">with</span> <span class="n">Wide</span><span class="o">&amp;</span><span class="n">Deep</span> <span class="n">model</span><span class="o">.</span> <span class="n">Sets</span> <span class="n">the</span> <span class="n">L2</span> <span class="n">reg</span> <span class="n">of</span>
                        <span class="n">the</span> <span class="n">wide</span><span class="o">/</span><span class="n">linear</span> <span class="n">sub</span><span class="o">-</span><span class="n">network</span><span class="o">.</span> <span class="n">By</span> <span class="n">default</span> <span class="mf">1e-5</span><span class="o">.</span>
  <span class="o">--</span><span class="n">wnd_ignore_combinations</span> 
                        <span class="n">Feature</span> <span class="n">interactions</span> <span class="n">to</span> <span class="n">ignore</span><span class="o">.</span> <span class="n">Separate</span> <span class="n">feature</span>
                        <span class="n">combinations</span> <span class="k">with</span> <span class="s1">&#39;,&#39;</span> <span class="ow">and</span> <span class="n">columns</span> <span class="k">with</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span> <span class="n">For</span>
                        <span class="n">example</span><span class="p">:</span> <span class="o">--</span><span class="n">wnd_ignore_combinations</span><span class="o">=</span><span class="s1">&#39;item_id:item</span>
                        <span class="n">_category</span><span class="p">,</span><span class="n">user_id</span><span class="p">:</span><span class="n">user_gender</span><span class="s1">&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="wide-deep-and-deepfm">
<h3>Wide&amp;Deep and DeepFM<a class="headerlink" href="#wide-deep-and-deepfm" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">--</span><span class="n">multihot_max_seq_length</span>
                        <span class="n">DeepFM</span> <span class="ow">and</span> <span class="n">Wide</span><span class="o">&amp;</span><span class="n">Deep</span> <span class="n">support</span> <span class="n">multi</span><span class="o">-</span><span class="n">hot</span>
                        <span class="n">categorical</span> <span class="n">features</span> <span class="k">for</span> <span class="n">the</span> <span class="n">wide</span><span class="o">/</span><span class="n">linear</span> <span class="n">sub</span><span class="o">-</span>
                        <span class="n">network</span><span class="o">.</span> <span class="n">But</span> <span class="n">they</span> <span class="n">require</span> <span class="n">setting</span> <span class="n">the</span> <span class="n">maximum</span>
                        <span class="nb">list</span> <span class="n">length</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="p">,</span> <span class="n">number</span> <span class="n">of</span> <span class="n">different</span> <span class="n">multi</span><span class="o">-</span><span class="n">hot</span>
                        <span class="n">values</span> <span class="n">that</span> <span class="n">can</span> <span class="n">exist</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">given</span> <span class="n">example</span><span class="o">.</span> <span class="n">By</span>
                        <span class="n">default</span> <span class="mf">5.</span>
</pre></div>
</div>
</div>
<div class="section" id="mmoe">
<h3>MMOE<a class="headerlink" href="#mmoe" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">--</span><span class="n">mmoe_num_mlp_experts</span> 
                        <span class="n">Number</span> <span class="n">of</span> <span class="n">experts</span> <span class="k">for</span> <span class="n">MMOE</span><span class="o">.</span> <span class="n">All</span> <span class="n">of</span> <span class="n">them</span> <span class="n">are</span>
                        <span class="n">shared</span> <span class="n">by</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">tasks</span><span class="o">.</span> <span class="n">By</span> <span class="n">default</span> <span class="mf">4.</span>
</pre></div>
</div>
</div>
<div class="section" id="cgc-and-ple">
<h3>CGC and PLE<a class="headerlink" href="#cgc-and-ple" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">--</span><span class="n">cgc_num_task_experts</span> 
                        <span class="n">Number</span> <span class="n">of</span> <span class="n">task</span><span class="o">-</span><span class="n">specific</span> <span class="n">experts</span> <span class="k">for</span> <span class="n">CGC</span> <span class="ow">and</span> <span class="n">PLE</span><span class="o">.</span>
                        <span class="n">By</span> <span class="n">default</span> <span class="mf">1.</span>
  <span class="o">--</span><span class="n">cgc_num_shared_experts</span> 
                        <span class="n">Number</span> <span class="n">of</span> <span class="n">shared</span> <span class="n">experts</span> <span class="k">for</span> <span class="n">CGC</span> <span class="ow">and</span> <span class="n">PLE</span><span class="o">.</span> <span class="n">By</span>
                        <span class="n">default</span> <span class="mf">2.</span>
  <span class="o">--</span><span class="n">ple_num_layers</span> 
                        <span class="n">Number</span> <span class="n">of</span> <span class="n">CGC</span> <span class="n">modules</span> <span class="n">to</span> <span class="n">stack</span> <span class="k">for</span> <span class="n">PLE</span>
                        <span class="n">architecture</span><span class="o">.</span> <span class="n">By</span> <span class="n">default</span> <span class="mf">1.</span>
</pre></div>
</div>
</div>
<div class="section" id="expert-based-mtl-models">
<h3>Expert-based MTL models<a class="headerlink" href="#expert-based-mtl-models" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">--</span><span class="n">expert_mlp_layers</span> 
                        <span class="n">For</span> <span class="n">MTL</span> <span class="n">models</span> <span class="p">(</span><span class="n">MMOE</span><span class="p">,</span> <span class="n">CGC</span><span class="p">,</span> <span class="n">PLE</span><span class="p">)</span> <span class="n">sets</span> <span class="n">the</span> <span class="n">MLP</span>
                        <span class="n">layers</span> <span class="n">of</span> <span class="n">experts</span><span class="o">.</span> 
                        <span class="n">It</span> <span class="n">expects</span> <span class="n">a</span> <span class="n">comma</span><span class="o">-</span><span class="n">separated</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">layer</span> <span class="n">dims</span><span class="o">.</span>
                        <span class="n">By</span> <span class="n">default</span> <span class="s1">&#39;64&#39;</span>
  <span class="o">--</span><span class="n">gate_dim</span>            <span class="n">Dimension</span> <span class="n">of</span> <span class="n">the</span> <span class="n">gate</span> <span class="n">dim</span> <span class="n">MLP</span> <span class="n">layer</span><span class="o">.</span> <span class="n">By</span> <span class="n">default</span>
                        <span class="mi">64</span>
  <span class="o">--</span><span class="n">mtl_gates_softmax_temperature</span> 
                        <span class="n">Sets</span> <span class="n">the</span> <span class="n">softmax</span> <span class="n">temperature</span> <span class="k">for</span> <span class="n">the</span> <span class="n">gates</span>
                        <span class="n">output</span> <span class="n">layer</span><span class="p">,</span> <span class="n">that</span> <span class="n">provides</span> <span class="n">weights</span> <span class="k">for</span> <span class="n">the</span>
                        <span class="n">weighted</span> <span class="n">average</span> <span class="n">of</span> <span class="n">experts</span> <span class="n">outputs</span><span class="o">.</span> <span class="n">By</span> <span class="n">default</span>
                        <span class="mf">1.0</span>
</pre></div>
</div>
</div>
<div class="section" id="multi-task-learning-models">
<h3>Multi-task learning models<a class="headerlink" href="#multi-task-learning-models" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">--</span><span class="n">use_task_towers</span> 
                        <span class="n">Creates</span> <span class="n">task</span><span class="o">-</span><span class="n">specific</span> <span class="n">MLP</span> <span class="n">tower</span> <span class="n">before</span> <span class="n">its</span> <span class="n">head</span><span class="o">.</span>
                        <span class="n">By</span> <span class="n">default</span> <span class="kc">True</span><span class="o">.</span>
  <span class="o">--</span><span class="n">tower_layers</span> 
                        <span class="n">MLP</span> <span class="n">architecture</span> <span class="n">of</span> <span class="n">task</span><span class="o">-</span><span class="n">specific</span> <span class="n">towers</span><span class="o">.</span> 
                        <span class="n">It</span> <span class="n">expects</span> <span class="n">a</span> <span class="n">comma</span><span class="o">-</span><span class="n">separated</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">layer</span> <span class="n">dims</span><span class="o">.</span>
                        <span class="n">By</span> <span class="n">default</span> <span class="s1">&#39;64&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h3>Negative sampling<a class="headerlink" href="#id1" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">--</span><span class="n">in_batch_negatives_train</span> 
                        <span class="n">If</span> <span class="n">greater</span> <span class="n">than</span> <span class="mi">0</span><span class="p">,</span> <span class="n">enables</span> <span class="ow">in</span><span class="o">-</span><span class="n">batch</span> <span class="n">sampling</span><span class="p">,</span>
                        <span class="n">providing</span> <span class="n">this</span> <span class="n">number</span> <span class="n">of</span> <span class="n">negative</span> <span class="n">samples</span> <span class="n">per</span>
                        <span class="n">positive</span><span class="o">.</span> <span class="n">This</span> <span class="n">requires</span> <span class="n">that</span> <span class="n">your</span> <span class="n">data</span> <span class="n">contains</span>
                        <span class="n">only</span> <span class="n">positive</span> <span class="n">examples</span><span class="p">,</span> <span class="ow">and</span> <span class="n">that</span> <span class="n">item</span> <span class="n">features</span>
                        <span class="n">are</span> <span class="n">tagged</span> <span class="n">accordingly</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">schema</span><span class="p">,</span> <span class="k">for</span>
                        <span class="n">example</span><span class="p">,</span> <span class="n">by</span> <span class="n">setting</span> <span class="o">--</span><span class="n">item_features</span> <span class="ow">in</span> <span class="n">the</span>
                        <span class="n">preprocessing</span> <span class="n">script</span><span class="o">.</span>
  <span class="o">--</span><span class="n">in_batch_negatives_eval</span> 
                        <span class="n">Same</span> <span class="k">as</span> <span class="o">--</span><span class="n">in_batch_negatives_train</span> <span class="k">for</span>
                        <span class="n">evaluation</span><span class="o">.</span>
</pre></div>
</div>
</div>
<div class="section" id="training-and-evaluation">
<h3>Training and evaluation<a class="headerlink" href="#training-and-evaluation" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">--</span><span class="n">lr</span> <span class="n">LR</span>               <span class="n">Learning</span> <span class="n">rate</span>
  <span class="o">--</span><span class="n">lr_decay_rate</span> 
                        <span class="n">Learning</span> <span class="n">rate</span> <span class="n">decay</span> <span class="n">factor</span><span class="o">.</span> <span class="n">By</span> <span class="n">default</span> <span class="mf">0.99</span>
  <span class="o">--</span><span class="n">lr_decay_steps</span> 
                        <span class="n">Learning</span> <span class="n">rate</span> <span class="n">decay</span> <span class="n">steps</span><span class="o">.</span> <span class="n">It</span> <span class="n">decreases</span> <span class="n">the</span> <span class="n">LR</span>
                        <span class="n">at</span> <span class="n">this</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">by</span> <span class="n">default</span> <span class="n">each</span> <span class="mi">100</span> <span class="n">steps</span>
  <span class="o">--</span><span class="n">train_batch_size</span> 
                        <span class="n">Train</span> <span class="n">batch</span> <span class="n">size</span><span class="o">.</span> <span class="n">By</span> <span class="n">default</span> <span class="mf">1024.</span> <span class="n">Larger</span> <span class="n">batch</span>
                        <span class="n">sizes</span> <span class="n">are</span> <span class="n">recommended</span> <span class="k">for</span> <span class="n">better</span> <span class="n">performance</span><span class="o">.</span>
  <span class="o">--</span><span class="n">eval_batch_size</span> 
                        <span class="n">Eval</span> <span class="n">batch</span> <span class="n">size</span><span class="o">.</span> <span class="n">By</span> <span class="n">default</span> <span class="mf">1024.</span> <span class="n">Larger</span> <span class="n">batch</span>
                        <span class="n">sizes</span> <span class="n">are</span> <span class="n">recommended</span> <span class="k">for</span> <span class="n">better</span> <span class="n">performance</span><span class="o">.</span>
  <span class="o">--</span><span class="n">epochs</span> <span class="n">EPOCHS</span>       <span class="n">Number</span> <span class="n">of</span> <span class="n">epochs</span><span class="o">.</span> <span class="n">By</span> <span class="n">default</span> <span class="mf">1.</span>
  <span class="o">--</span><span class="n">optimizer</span> <span class="p">{</span><span class="n">adagrad</span><span class="p">,</span><span class="n">adam</span><span class="p">}</span>
                        <span class="n">Optimizer</span><span class="o">.</span> <span class="n">By</span> <span class="n">default</span> <span class="s1">&#39;adam&#39;</span>
  <span class="o">--</span><span class="n">train_metrics_steps</span> 
                        <span class="n">How</span> <span class="n">often</span> <span class="n">should</span> <span class="n">train</span> <span class="n">metrics</span> <span class="n">be</span> <span class="n">computed</span>
                        <span class="n">during</span> <span class="n">training</span><span class="o">.</span> <span class="n">You</span> <span class="n">might</span> <span class="n">increase</span> <span class="n">this</span> <span class="n">number</span>
                        <span class="n">to</span> <span class="n">reduce</span> <span class="n">the</span> <span class="n">frequency</span> <span class="ow">and</span> <span class="n">increase</span> <span class="n">a</span> <span class="n">bit</span> <span class="n">the</span>
                        <span class="n">training</span> <span class="n">throughput</span><span class="o">.</span> <span class="n">By</span> <span class="n">default</span> <span class="mf">10.</span>
  <span class="o">--</span><span class="n">validation_steps</span> 
                        <span class="n">If</span> <span class="ow">not</span> <span class="n">predicting</span><span class="p">,</span> <span class="n">logs</span> <span class="n">the</span> <span class="n">validation</span> <span class="n">metrics</span>
                        <span class="k">for</span> <span class="n">this</span> <span class="n">number</span> <span class="n">of</span> <span class="n">steps</span> <span class="n">at</span> <span class="n">the</span> <span class="n">end</span> <span class="n">of</span> <span class="n">each</span>
                        <span class="n">training</span> <span class="n">epoch</span><span class="o">.</span> <span class="n">By</span> <span class="n">default</span> <span class="mf">10.</span>
  <span class="o">--</span><span class="n">random_seed</span> 
                        <span class="n">Random</span> <span class="n">seed</span> <span class="k">for</span> <span class="n">some</span> <span class="n">reproducibility</span><span class="o">.</span> <span class="n">By</span> <span class="n">default</span>
                        <span class="mf">42.</span>
  <span class="o">--</span><span class="n">train_steps_per_epoch</span> 
                        <span class="n">Number</span> <span class="n">of</span> <span class="n">train</span> <span class="n">steps</span> <span class="n">per</span> <span class="n">epoch</span><span class="o">.</span> <span class="n">Set</span> <span class="n">this</span> <span class="k">for</span>
                        <span class="n">quick</span> <span class="n">debugging</span><span class="o">.</span>
  <span class="o">--</span><span class="n">shuffled_train</span>
                        <span class="n">Shuffles</span> <span class="n">data</span> <span class="n">during</span> <span class="n">training</span><span class="o">.</span>
</pre></div>
</div>
</div>
<div class="section" id="logging">
<h3>Logging<a class="headerlink" href="#logging" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">--</span><span class="n">metrics_log_frequency</span> 
                        <span class="o">--</span><span class="n">How</span> <span class="n">often</span> <span class="n">metrics</span> <span class="n">should</span> <span class="n">be</span> <span class="n">logged</span> <span class="n">to</span>
                        <span class="n">Tensorboard</span> <span class="ow">or</span> <span class="n">Weights</span><span class="o">&amp;</span><span class="n">Biases</span><span class="o">.</span> <span class="n">By</span> <span class="n">default</span> <span class="n">each</span>
                        <span class="mi">50</span> <span class="n">steps</span><span class="o">.</span>
  <span class="o">--</span><span class="n">log_to_tensorboard</span> 
                        <span class="n">Enables</span> <span class="n">logging</span> <span class="n">to</span> <span class="n">Tensorboard</span><span class="o">.</span>
  <span class="o">--</span><span class="n">log_to_wandb</span> 
                        <span class="n">Enables</span> <span class="n">logging</span> <span class="n">to</span> <span class="n">Weights</span><span class="o">&amp;</span><span class="n">Biases</span><span class="o">.</span> <span class="n">This</span> <span class="n">requires</span> 
                        <span class="n">sign</span><span class="o">-</span><span class="n">up</span> <span class="k">for</span> <span class="n">a</span> <span class="n">free</span> <span class="n">Weights</span><span class="o">&amp;</span><span class="n">Biases</span> <span class="n">account</span> <span class="n">at</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">wandb</span><span class="o">.</span><span class="n">ai</span><span class="o">/</span>
                        <span class="ow">and</span> <span class="n">providing</span> <span class="n">an</span> <span class="n">API</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">console</span> <span class="n">you</span> <span class="n">can</span> <span class="n">get</span> <span class="n">at</span> 
                        <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">wandb</span><span class="o">.</span><span class="n">ai</span><span class="o">/</span><span class="n">authorize</span>
  <span class="o">--</span><span class="n">wandb_project</span> 
                        <span class="n">Name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Weights</span><span class="o">&amp;</span><span class="n">Biases</span> <span class="n">project</span> <span class="n">to</span> <span class="n">log</span>
  <span class="o">--</span><span class="n">wandb_entity</span> 
                        <span class="n">Name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Weights</span><span class="o">&amp;</span><span class="n">Biases</span> <span class="n">team</span><span class="o">/</span><span class="n">org</span> <span class="n">to</span> <span class="n">log</span>
  <span class="o">--</span><span class="n">wandb_exp_group</span> 
                        <span class="n">Not</span> <span class="n">used</span> <span class="n">by</span> <span class="n">the</span> <span class="n">script</span><span class="o">.</span> <span class="n">Just</span> <span class="n">used</span> <span class="n">to</span> <span class="n">allow</span> <span class="k">for</span>
                        <span class="n">logging</span> <span class="n">some</span> <span class="n">info</span> <span class="n">to</span> <span class="n">organize</span> <span class="n">experiments</span> <span class="ow">in</span>
                        <span class="n">Weights</span><span class="o">&amp;</span><span class="n">Biases</span>
</pre></div>
</div>
<p>This requires sign-up for a free Weights&amp;Biases account at <a class="reference external" href="https://wandb.ai/home">https://wandb.ai/home</a> “
“and providing an API key in the console.</p>
</div>
<div class="section" id="outputs">
<h3>Outputs<a class="headerlink" href="#outputs" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">--</span><span class="n">output_path</span>
                        <span class="n">Folder</span> <span class="n">to</span> <span class="n">save</span> <span class="n">training</span> <span class="ow">and</span> <span class="n">logging</span> <span class="n">assets</span><span class="o">.</span>
  <span class="o">--</span><span class="n">save_model_path</span> 
                        <span class="n">If</span> <span class="n">provided</span><span class="p">,</span> <span class="n">model</span> <span class="ow">is</span> <span class="n">saved</span> <span class="n">to</span> <span class="n">this</span> <span class="n">path</span> <span class="n">after</span>
                        <span class="n">training</span><span class="o">.</span> <span class="n">It</span> <span class="n">can</span> <span class="n">be</span> <span class="n">loaded</span> <span class="n">later</span> <span class="k">with</span> <span class="o">--</span><span class="n">load_model_path</span> 
  <span class="o">--</span><span class="n">predict_output_path</span> 
                        <span class="n">If</span> <span class="n">provided</span> <span class="n">the</span> <span class="n">prediction</span> <span class="n">scores</span> <span class="n">will</span> <span class="n">be</span> <span class="n">saved</span>
                        <span class="n">to</span> <span class="n">this</span> <span class="n">path</span><span class="p">,</span> <span class="n">according</span> <span class="n">to</span> <span class="o">--</span><span class="n">predict_output_format</span>
                        <span class="ow">and</span> <span class="o">--</span><span class="n">predict_output_keep_cols</span> 
  <span class="o">--</span><span class="n">predict_output_keep_cols</span> 
                        <span class="n">Comma</span><span class="o">-</span><span class="n">separated</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">columns</span> <span class="n">to</span> <span class="n">keep</span> <span class="ow">in</span> <span class="n">the</span>
                        <span class="n">output</span> <span class="n">prediction</span> <span class="n">file</span><span class="o">.</span> <span class="n">If</span> <span class="n">no</span> <span class="n">columns</span> <span class="ow">is</span>
                        <span class="n">provided</span><span class="p">,</span> <span class="nb">all</span> <span class="n">columns</span> <span class="n">are</span> <span class="n">kept</span> <span class="n">together</span> <span class="k">with</span> <span class="n">the</span>
                        <span class="n">prediction</span> <span class="n">scores</span><span class="o">.</span>  
  <span class="o">--</span><span class="n">predict_output_format</span> <span class="p">{</span><span class="n">parquet</span><span class="p">,</span><span class="n">csv</span><span class="p">,</span><span class="n">tsv</span><span class="p">}</span>
                        <span class="n">Format</span> <span class="n">of</span> <span class="n">the</span> <span class="n">output</span> <span class="n">prediction</span> <span class="n">files</span><span class="o">.</span> <span class="n">By</span>
                        <span class="n">default</span> <span class="s1">&#39;parquet&#39;</span><span class="p">,</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">most</span> <span class="n">performant</span>
                        <span class="nb">format</span><span class="o">.</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, NVIDIA.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NVJ1Y1YJHK"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-NVJ1Y1YJHK', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>